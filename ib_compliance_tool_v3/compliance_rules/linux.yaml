rules:
  - id: "postgresql_version"
    name: "PostgreSQL Version Check"
    description: "Проверка версии PostgreSQL на соответствие требованиям"
    severity: "HIGH"
    type: "list_versions"
    check:
      command: "cat /etc/testpost.conf 2>/dev/null || echo 'NOT_INSTALLED'"
      #command: "psql --version 2>/dev/null || postgres --version 2>/dev/null ||  echo 'NOT_INSTALLED'"
      expect: "13.22,14.19,15.14,16.10,17.6"
      comparison: "min"

  - id: "password_max_days"
    name: "Password Maximum Age"
    description: "Максимальный срок действия пароля не более 90 дней"
    severity: "MEDIUM"
    type: "numeric_max"
    check:
      command: "grep '^PASS_MAX_DAYS' /etc/login.defs | grep -v '^#'"
      expect: "PASS_MAX_DAYS 90"

  - id: "pam_tally_auth"
    name: "PAM Tally Auth Configuration"
    description: "Блокировка после 3 неудачных попыток входа"
    severity: "HIGH"
    type: "contains"
    check:
      command: "grep 'pam_tally.so' /etc/pam.d/common-auth | grep -v '^#' | tr '\t' ' ' | tr -s ' '"
      expect: "auth [success=ignore default=die] pam_tally.so per_user deny=3 lock_time=5 unlock_time=900"

  - id: "pam_tally_account"
    name: "PAM Tally Account Configuration"
    description: "Настройки блокировки учетных записей"
    severity: "HIGH"
    type: "contains"
    check:
      command: "grep 'pam_tally.so' /etc/pam.d/common-account | grep -v '^#' | tr '\t' ' ' | tr -s ' '"
      expect: "account required pam_tally.so per_user deny=4 lock_time=5 unlock_time=900"

  - id: "password_min_days"
    name: "Password Minimum Age"
    description: "Минимальный срок действия пароля 7 дней"
    severity: "MEDIUM"
    type: "numeric_equals"
    check:
      command: "grep '^PASS_MIN_DAYS' /etc/login.defs | grep -v '^#'"
      expect: "PASS_MIN_DAYS 7"

  - id: "password_warn_age"
    name: "Password Warning Age"
    description: "Предупреждение за 7 дней до истечения пароля"
    severity: "LOW"
    type: "numeric_equals"
    check:
      command: "grep '^PASS_WARN_AGE' /etc/login.defs | grep -v '^#'"
      expect: "PASS_WARN_AGE 7"

  - id: "pam_password_policy"
    name: "PAM Password Policy"
    description: "Политика сложности паролей"
    severity: "MEDIUM"
    type: "contains_multiple"
    check:
      command: "grep 'pam_cracklib.so' /etc/pam.d/common-password | grep -v '^#'"
      expect: "retry=3 minlen=8 difok=3 dcredit=-1 ucredit=-1 lcredit=-1"

  - id: "session_timeout"
    name: "Session Timeout"
    description: "Таймаут сессии 900 секунд"
    severity: "MEDIUM"
    type: "contains"
    check:
      command: "grep '^TMOUT=' /etc/environment"
      expect: "TMOUT=900"

  - id: "fstab_sec_del"
    name: "Filesystem Security Deletion"
    description: "Настройки безопасного удаления в fstab"
    severity: "MEDIUM"
    type: "contains"
    check:
      command: "grep 'secdel' /etc/fstab"
      expect: "secdel"

  - id: "afick_critical_files"
    name: "AFICK Critical Files Monitoring"
    description: "Контроль целостности критических файлов"
    severity: "HIGH"
    type: "file_contains_lines"
    check:
      command: "sudo cat /etc/afick.conf"
      expect: |
        /etc/group MyRule
        /etc/passwd MyRule
        /etc/gshadow MyRule
        /etc/shadow MyRule
        /etc/security/opasswd MyRule
        /etc/sudoers MyRule
        /etc/hosts MyRule
        /etc/network MyRule

  - id: "usb_storage_block"
    name: "USB Storage Block"
    description: "Блокировка USB-накопителей"
    severity: "MEDIUM"
    type: "contains"
    check:
      command: "cat /etc/udev/rules.d/99-usb.rules 2>/dev/null || echo 'FILE_NOT_FOUND'"
      expect: 'ENV{ID_USB_DRIVER}=="usb-storage",ENV{UDISKS_IGNORE}="1"'